{"schemas":"--- original\n+++ modified\n@@ -1,7 +1,18 @@\n+DEFINE TABLE last_presence AS\r\n+\tSELECT\r\n+        user,\r\n+        room,\r\n+        time::max(updated_at) AS at\r\n+    FROM presence\r\n+    WHERE status = \"joined\"\r\n+\tGROUP BY user, room\r\n+PERMISSIONS \r\n+    FOR select WHERE user == $auth.id\r\n+    FOR create, update, delete NONE;\n DEFINE TABLE presence SCHEMAFULL\r\n     PERMISSIONS\r\n-        FOR select\r\n-        FOR create, update WHERE user.id = $auth.id\r\n+        FOR select FULL\r\n+        FOR create, update WHERE user == $auth.id\r\n         FOR delete NONE;\r\n \r\n DEFINE FIELD room ON presence TYPE record<room>;\r\n@@ -10,11 +21,14 @@\n DEFINE FIELD status ON presence TYPE string ASSERT $value IN [\"joined\", \"left\"] DEFAULT \"joined\";\n DEFINE TABLE room SCHEMAFULL\r\n     PERMISSIONS\r\n-        FOR select\r\n+        FOR select FULL\r\n         FOR create, update, delete NONE;\r\n \r\n DEFINE FIELD name ON room TYPE string;\r\n-DEFINE FIELD created_at ON room TYPE datetime DEFAULT time::now();\n+DEFINE FIELD owner ON room TYPE option<record<user>>;\r\n+DEFINE FIELD created_at ON room TYPE datetime DEFAULT time::now();\r\n+\r\n+DEFINE INDEX unique_name ON room COLUMNS name UNIQUE;\n DEFINE TABLE script_migration SCHEMAFULL\n     PERMISSIONS\n         FOR select FULL\n@@ -25,12 +39,14 @@\n DEFINE TABLE user SCHEMALESS\r\n     PERMISSIONS\r\n         FOR select FULL\r\n-        FOR update WHERE id = $auth.id\r\n+        FOR update WHERE id == $auth.id\r\n         FOR create, delete NONE;\r\n \r\n DEFINE FIELD username ON user TYPE string;\r\n DEFINE FIELD email ON user TYPE string;\r\n-DEFINE FIELD password ON user TYPE string;\r\n+DEFINE FIELD password ON user TYPE string PERMISSIONS FOR select NONE;\r\n+DEFINE FIELD registered_at ON user TYPE datetime DEFAULT time::now();\r\n+DEFINE FIELD avatar ON user TYPE option<string>;\r\n \r\n DEFINE INDEX unique_username ON user COLUMNS username UNIQUE;\r\n DEFINE INDEX unique_email ON user COLUMNS email UNIQUE;\r\n@@ -40,8 +56,9 @@\n     SIGNUP (\r\n         CREATE user\r\n         SET\r\n-            name = $name,\r\n+            username = $username,\r\n             email = $email,\r\n+            avatar = \"https://www.gravatar.com/avatar/\" + crypto::md5($email),\r\n             password = crypto::argon2::generate($password)\r\n     )\r\n     SIGNIN (\r\n","events":"--- original\n+++ modified\n@@ -1,4 +1,34 @@\n-DEFINE TABLE join_room SCHEMALESS;\n+DEFINE TABLE create_room SCHEMALESS\r\n+    PERMISSIONS \r\n+        FOR create WHERE $auth\r\n+        FOR select, update, delete NONE;\r\n+\r\n+DEFINE EVENT create_room ON TABLE create_room WHEN $event == \"CREATE\" THEN {\r\n+    LET $rooms = (\r\n+        SELECT * \r\n+        FROM room \r\n+        WHERE owner == $auth.id\r\n+    );\r\n+\r\n+    LET $is_room_already_created = count($rooms) > 0;\r\n+\r\n+    IF $is_room_already_created THEN\r\n+    {\r\n+        THROW \"You cannot create more than one room.\";\r\n+    }\r\n+    ELSE\r\n+    {\r\n+        LET $room_name = \"@\" + $auth.username + \"'s room\";\r\n+        LET $new_rooms = CREATE room SET name = $room_name, owner = $auth.id;\r\n+        LET $own_room = $new_rooms[0];\r\n+        CREATE presence SET room = $own_room.id, user = $auth.id;\r\n+    }\r\n+    END;\r\n+};\n+DEFINE TABLE join_room SCHEMALESS\n+    PERMISSIONS \n+        FOR create WHERE $auth\n+        FOR select, update, delete NONE;\n\n DEFINE FIELD room_id ON join_room TYPE record<room>;\n\n@@ -7,13 +37,22 @@\n         SELECT * FROM presence \n         WHERE room = $after.room_id AND user = $auth.id;\n\n-    IF count($presence) == 0 THEN\n-        ( CREATE presence WHERE room = $after.room_id AND user = $auth.id )\n+    LET $has_presence_record = count($presence) > 0;\n+\n+    IF $has_presence_record THEN\n+    {\n+        UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id;\n+    }\n     ELSE\n-        ( UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id )\n-    END\n+    {\n+        CREATE presence SET room = $after.room_id, user = $auth.id;\n+    }\n+    END;\n };\n-DEFINE TABLE leave_room SCHEMALESS;\n+DEFINE TABLE leave_room SCHEMALESS\n+    PERMISSIONS \n+        FOR create WHERE $auth\n+        FOR select, update, delete NONE;\n\n DEFINE FIELD room_id ON leave_room TYPE record<room>;\n\n@@ -22,13 +61,22 @@\n         SELECT * FROM presence \n         WHERE room = $after.room_id AND user = $auth.id;\n\n-    IF count($presence) == 0 THEN\n-        ERROR \"You are not in this room\";\n+    LET $has_presence_record = count($presence) > 0;\n+\n+    IF $has_presence_record THEN\n+    {\n+        UPDATE presence SET status = \"left\" WHERE room = $after.room_id AND user = $auth.id;\n+    }\n     ELSE\n-        ( UPDATE presence SET status = \"left\" WHERE room = $after.room_id AND user = $auth.id )\n-    END\n+    {\n+        THROW \"You are not in this room\";\n+    }\n+    END;\n };\n-DEFINE TABLE signal_presence SCHEMALESS;\n+DEFINE TABLE signal_presence SCHEMALESS\n+    PERMISSIONS \n+        FOR create WHERE $auth\n+        FOR select, update, delete NONE;\n\n DEFINE FIELD room_id ON signal_presence TYPE record<room>;\n\n"}