{"schemas":"--- original\n+++ modified\n@@ -1,7 +1,7 @@\n DEFINE TABLE presence SCHEMAFULL\r\n     PERMISSIONS\r\n-        FOR select\r\n-        FOR create, update WHERE user.id = $auth.id\r\n+        FOR select FULL\r\n+        FOR create, update WHERE user = $auth.id\r\n         FOR delete NONE;\r\n \r\n DEFINE FIELD room ON presence TYPE record<room>;\r\n@@ -10,7 +10,7 @@\n DEFINE FIELD status ON presence TYPE string ASSERT $value IN [\"joined\", \"left\"] DEFAULT \"joined\";\n DEFINE TABLE room SCHEMAFULL\r\n     PERMISSIONS\r\n-        FOR select\r\n+        FOR select FULL\r\n         FOR create, update, delete NONE;\r\n \r\n DEFINE FIELD name ON room TYPE string;\r\n@@ -30,7 +30,9 @@\n \r\n DEFINE FIELD username ON user TYPE string;\r\n DEFINE FIELD email ON user TYPE string;\r\n-DEFINE FIELD password ON user TYPE string;\r\n+DEFINE FIELD password ON user TYPE string PERMISSIONS FOR select NONE;\r\n+DEFINE FIELD registered_at ON user TYPE datetime DEFAULT time::now();\r\n+DEFINE FIELD avatar ON user TYPE option<string>;\r\n \r\n DEFINE INDEX unique_username ON user COLUMNS username UNIQUE;\r\n DEFINE INDEX unique_email ON user COLUMNS email UNIQUE;\r\n@@ -40,8 +42,9 @@\n     SIGNUP (\r\n         CREATE user\r\n         SET\r\n-            name = $name,\r\n+            username = $username,\r\n             email = $email,\r\n+            avatar = \"https://www.gravatar.com/avatar/\" + crypto::md5($email),\r\n             password = crypto::argon2::generate($password)\r\n     )\r\n     SIGNIN (\r\n","events":"--- original\n+++ modified\n@@ -7,11 +7,17 @@\n         SELECT * FROM presence \n         WHERE room = $after.room_id AND user = $auth.id;\n\n-    IF count($presence) == 0 THEN\n-        ( CREATE presence WHERE room = $after.room_id AND user = $auth.id )\n+    LET $has_presence_record = count($presence) > 0;\n+\n+    IF $has_presence_record THEN\n+    {\n+        UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id;\n+    }\n     ELSE\n-        ( UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id )\n-    END\n+    {\n+        CREATE presence SET room = $after.room_id, user = $auth.id;\n+    }\n+    END;\n };\n DEFINE TABLE leave_room SCHEMALESS;\n\n@@ -22,11 +28,17 @@\n         SELECT * FROM presence \n         WHERE room = $after.room_id AND user = $auth.id;\n\n-    IF count($presence) == 0 THEN\n-        ERROR \"You are not in this room\";\n+    LET $has_presence_record = count($presence) > 0;\n+\n+    IF $has_presence_record THEN\n+    {\n+        UPDATE presence SET status = \"left\" WHERE room = $after.room_id AND user = $auth.id;\n+    }\n     ELSE\n-        ( UPDATE presence SET status = \"left\" WHERE room = $after.room_id AND user = $auth.id )\n-    END\n+    {\n+        THROW \"You are not in this room\";\n+    }\n+    END;\n };\n DEFINE TABLE signal_presence SCHEMALESS;\n\n"}