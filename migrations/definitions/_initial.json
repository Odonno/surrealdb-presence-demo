{"schemas":"DEFINE TABLE presence SCHEMAFULL\r\n    PERMISSIONS\r\n        FOR select\r\n        FOR create, update WHERE user.id = $auth.id\r\n        FOR delete NONE;\r\n\r\nDEFINE FIELD room ON presence TYPE record<room>;\r\nDEFINE FIELD user ON presence TYPE record<user>;\r\nDEFINE FIELD updated_at ON presence TYPE datetime VALUE time::now() DEFAULT time::now();\r\nDEFINE FIELD status ON presence TYPE string ASSERT $value IN [\"joined\", \"left\"] DEFAULT \"joined\";\nDEFINE TABLE room SCHEMAFULL\r\n    PERMISSIONS\r\n        FOR select\r\n        FOR create, update, delete NONE;\r\n\r\nDEFINE FIELD name ON room TYPE string;\r\nDEFINE FIELD created_at ON room TYPE datetime DEFAULT time::now();\nDEFINE TABLE script_migration SCHEMAFULL\n    PERMISSIONS\n        FOR select FULL\n        FOR create, update, delete NONE;\n\nDEFINE FIELD script_name ON script_migration TYPE string;\nDEFINE FIELD executed_at ON script_migration TYPE datetime DEFAULT time::now();\nDEFINE TABLE user SCHEMALESS\r\n    PERMISSIONS\r\n        FOR select FULL\r\n        FOR update WHERE id = $auth.id\r\n        FOR create, delete NONE;\r\n\r\nDEFINE FIELD username ON user TYPE string;\r\nDEFINE FIELD email ON user TYPE string;\r\nDEFINE FIELD password ON user TYPE string;\r\n\r\nDEFINE INDEX unique_username ON user COLUMNS username UNIQUE;\r\nDEFINE INDEX unique_email ON user COLUMNS email UNIQUE;\r\n\r\nDEFINE SCOPE user_scope\r\n    SESSION 7d\r\n    SIGNUP (\r\n        CREATE user\r\n        SET\r\n            name = $name,\r\n            email = $email,\r\n            password = crypto::argon2::generate($password)\r\n    )\r\n    SIGNIN (\r\n        SELECT *\r\n        FROM user\r\n        WHERE email = $email AND crypto::argon2::compare(password, $password)\r\n    );\r\n","events":"DEFINE TABLE join_room SCHEMALESS;\n\nDEFINE FIELD room_id ON join_room TYPE record<room>;\n\nDEFINE EVENT join_room ON TABLE join_room WHEN $event == \"CREATE\" THEN {\n    LET $presence = \n        SELECT * FROM presence \n        WHERE room = $after.room_id AND user = $auth.id;\n\n    IF count($presence) == 0 THEN\n        ( CREATE presence WHERE room = $after.room_id AND user = $auth.id )\n    ELSE\n        ( UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id )\n    END\n};\nDEFINE TABLE leave_room SCHEMALESS;\n\nDEFINE FIELD room_id ON leave_room TYPE record<room>;\n\nDEFINE EVENT leave_room ON TABLE leave_room WHEN $event == \"CREATE\" THEN {\n    LET $presence = \n        SELECT * FROM presence \n        WHERE room = $after.room_id AND user = $auth.id;\n\n    IF count($presence) == 0 THEN\n        ERROR \"You are not in this room\";\n    ELSE\n        ( UPDATE presence SET status = \"left\" WHERE room = $after.room_id AND user = $auth.id )\n    END\n};\nDEFINE TABLE signal_presence SCHEMALESS;\n\nDEFINE FIELD room_id ON signal_presence TYPE record<room>;\n\nDEFINE EVENT signal_presence ON TABLE signal_presence WHEN $event == \"CREATE\" THEN (\n    UPDATE presence SET status = \"joined\" WHERE room = $after.room_id AND user = $auth.id\n);"}